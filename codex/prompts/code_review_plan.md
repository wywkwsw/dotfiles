---
description: 对项目进行 Code Review 并生成 plan/*.md 执行计划（支持三种审查范围）[SCOPE=global|unpushed|uncommitted] [FOCUS=<可选聚焦领域>]
argument-hint: "[SCOPE=global|unpushed|uncommitted] [FOCUS=<可选聚焦领域>]"

---

你现在处于「Code Review → Plan 模式」。

目标：根据指定的审查范围对代码进行 Code Review，识别问题与改进点，并生成结构化的 `plan/*.md` 执行计划文件，供后续 `/prompts:plan_to_issues_csv` 消费。

> 核心原则：Code Review 不是挑刺，而是发现**真正需要解决的问题**和**可落地的改进机会**。  
> Plan 文件是"技术债务/改进项的契约"，不是流水账。

---

## ⚠️ 第零步：参数解析（必须首先执行）

**在执行任何操作之前，必须先解析用户输入的参数！**

### 参数解析规则

从 `$ARGUMENTS` 中提取参数，按以下优先级解析：

1. **显式 `SCOPE=xxx`**：如果用户输入包含 `SCOPE=global`、`SCOPE=unpushed` 或 `SCOPE=uncommitted`，**必须使用该值**
2. **隐式关键词**：如果用户输入包含 `global`、`unpushed`、`uncommitted` 等关键词（不带 `SCOPE=` 前缀），也应识别为 SCOPE
3. **默认值**：仅当用户完全未指定任何范围时，才使用默认值 `uncommitted`

### 解析示例

| 用户输入 | 解析结果 |
|----------|----------|
| `SCOPE=global` | ✅ `SCOPE=global` |
| `global` | ✅ `SCOPE=global` |
| `SCOPE=unpushed FOCUS=性能` | ✅ `SCOPE=unpushed`, `FOCUS=性能` |
| `unpushed` | ✅ `SCOPE=unpushed` |
| `FOCUS=安全` | ✅ `SCOPE=uncommitted`（默认）, `FOCUS=安全` |
| （空） | ✅ `SCOPE=uncommitted`（默认） |

### 确认输出

解析完成后，**必须先输出确认信息**：

```
📋 参数解析结果：
- SCOPE: <global|unpushed|uncommitted>
- FOCUS: <聚焦领域 或 "全面审查">
```

---

## ⚡ 第一步：调用 ACE 上下文引擎（必须执行）

**在读取任何文件之前，必须先调用 `ace-tool` 获取代码上下文！**

### 为什么必须使用 ACE

| 方式 | 速度 | 上下文质量 | 推荐度 |
|------|------|------------|--------|
| 逐文件读取 | 🐢 极慢 | 碎片化 | ❌ |
| ACE 语义搜索 | ⚡ 快速 | 结构化 | ✅ 必须使用 |

### ACE 调用策略（按 SCOPE 分类）

#### SCOPE=global（全局审查）

```
调用 ace-tool:
  - query: "项目整体架构分析：入口文件、核心模块、公共工具、外部依赖、模块边界"
  - project_root_path: <项目根目录绝对路径>

然后根据 ACE 返回的结构，进一步查询：
  - query: "代码质量问题：重复代码、过长函数、复杂度高的模块、未使用的导出"
  - query: "潜在风险：错误处理缺失、类型安全问题、安全漏洞、性能瓶颈"
```

#### SCOPE=unpushed（未推送审查）

```
1. 先执行 git 命令获取变更文件列表：
   git diff --name-only @{u}..HEAD

2. 调用 ace-tool:
   - query: "分析以下变更文件的影响范围、依赖关系、类型安全性：<file_list>"
   - project_root_path: <项目根目录绝对路径>

3. 针对关键变更深入查询：
   - query: "变更 <file> 对其调用者的影响，可能的破坏性变更"
```

#### SCOPE=uncommitted（未提交审查）

```
1. 先执行 git 命令获取变更文件列表：
   git diff --name-only HEAD
   git ls-files --others --exclude-standard

2. 调用 ace-tool:
   - query: "分析当前未提交变更的代码质量：<file_list>"
   - project_root_path: <项目根目录绝对路径>
```

### ACE 调用输出确认

```
🔍 ACE 上下文加载完成：
- 索引文件数: N
- 识别符号数: M
- 核心模块: <modules>
- 入口点: <entry_files>
```

---

## 二、审查范围详细说明

### 1. `global` — 全局项目审查

对整个项目进行全面 Code Review，适用于：
- 新接手项目的全面摸底
- 定期技术债务盘点
- 架构/质量专项审计

**获取范围命令（ACE 调用后补充执行）：**
```bash
# 列出所有被 git 跟踪的源文件
git ls-files | grep -E '\.(ts|tsx|js|jsx|py|go|rs|java|swift|kt|vue|svelte|css|scss)$'
```

### 2. `unpushed` — 未推送变更审查

对已 commit 但尚未 push 到远程仓库的变更进行 Code Review，适用于：
- Push 前的自检
- PR 前的预审
- 批量 commit 后的复查

**获取范围命令：**
```bash
# 获取本地领先于远程的 commit 列表
git log @{u}..HEAD --oneline

# 获取这些 commit 中变更的文件
git diff --name-only @{u}..HEAD

# 查看具体变更内容
git diff @{u}..HEAD
```

### 3. `uncommitted` — 未提交变更审查（默认）

对当前工作区中已修改但未 commit 的文件进行 Code Review，适用于：
- Commit 前的自检
- 开发过程中的即时审查
- 修复 bug 后的验证

**获取范围命令：**
```bash
# 已暂存的文件
git diff --name-only --cached

# 未暂存的修改文件
git diff --name-only

# 未跟踪的新文件
git ls-files --others --exclude-standard

# 查看所有未提交的变更内容
git diff HEAD
```

---

## 三、总体行为约定（必须遵守）

1. **必须先解析 SCOPE 参数**，不得忽略用户显式指定的范围。
2. **必须先调用 ACE MCP** 获取上下文，不得跳过直接读文件。
3. **必须阅读实际代码**后再给出审查意见，不得仅凭文件名推断。
4. 审查发现必须分类、分优先级，并给出**可操作的改进建议**。
5. 生成的 plan 文件必须可被 `/prompts:plan_to_issues_csv` 直接消费。
6. 如果 `$FOCUS` 非空，优先关注该领域（如 `FOCUS=性能`、`FOCUS=安全`、`FOCUS=可读性`）。

---

## 四、Code Review 检查清单

按以下维度进行审查（根据 FOCUS 可调整权重）：

### 4.1 架构与设计
- [ ] 模块划分是否合理（高内聚、低耦合）
- [ ] 是否存在循环依赖
- [ ] 抽象层次是否恰当（过度抽象/抽象不足）
- [ ] 是否遵循 SOLID 原则

### 4.2 代码质量
- [ ] 命名是否清晰（变量/函数/类/文件）
- [ ] 函数长度是否合理（建议 < 50 行）
- [ ] 是否存在重复代码（DRY 违规）
- [ ] 是否存在魔法数字/硬编码
- [ ] 注释是否充分且有价值

### 4.3 错误处理
- [ ] 是否有适当的错误处理/try-catch
- [ ] 错误信息是否有助于调试
- [ ] 边界条件是否覆盖（null/undefined/空数组等）
- [ ] 异步操作是否正确处理错误

### 4.4 性能
- [ ] 是否存在 N+1 查询
- [ ] 是否有不必要的重复计算
- [ ] 是否有内存泄漏风险
- [ ] 大列表是否考虑分页/虚拟化

### 4.5 安全
- [ ] 用户输入是否验证/转义
- [ ] 是否存在 SQL 注入/XSS 风险
- [ ] 敏感信息是否硬编码
- [ ] 权限检查是否完整

### 4.6 可测试性
- [ ] 函数是否便于单元测试
- [ ] 依赖是否可注入/mock
- [ ] 是否存在隐式全局状态

### 4.7 可维护性
- [ ] 类型定义是否完整（TS/类型注解）
- [ ] 是否有过时的 TODO/FIXME
- [ ] 依赖版本是否合理
- [ ] 是否有废弃/未使用的代码

---

## 五、Plan 文件输出格式

生成的 plan 文件必须符合以下结构：

```markdown
# Code Review Plan: <简短标题>

> 审查范围：<global|unpushed|uncommitted>  
> 审查时间：<YYYY-MM-DD HH:mm>  
> 聚焦领域：<FOCUS 或 "全面审查">  
> ACE 上下文：已加载 N 文件 / M 符号

## 📊 概览

| 指标 | 数值 |
|------|------|
| 审查文件数 | N |
| 发现问题数 | N |
| 严重程度分布 | 🔴 N / 🟡 N / 🟢 N |

## 🔴 Phase 0: 紧急/阻断性问题

> 必须立即修复，阻塞发布或存在安全风险

### 0.1 <问题标题>
- **文件**: `path/to/file.ts:L10-L20`
- **问题描述**: ...
- **影响范围**: ...（ACE 分析结果）
- **建议修复**: ...
- **验收标准**: ...

## 🟡 Phase 1: 重要改进项

> 应尽快处理，影响代码质量或可维护性

### 1.1 <问题标题>
...

## 🟢 Phase 2: 建议优化项

> 锦上添花，有时间时处理

### 2.1 <问题标题>
...

## 📎 参考

- 涉及文件清单
- 相关文档/规范链接
- ACE 洞察摘要
```

---

## 六、文件命名与存储

1. 目录：确保项目根目录下存在 `plan/`（不存在则创建）。
2. 命名规则：`plan/YYYY-MM-DD_code-review-<scope>.md`
   - 示例：`plan/2025-01-15_code-review-global.md`
3. 如果同一天多次审查，追加序号：`...-global-2.md`

---

## 七、完整执行流程（严格按顺序）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 0: 参数解析                                             │
│   - 解析 SCOPE（显式 > 隐式 > 默认）                          │
│   - 解析 FOCUS                                               │
│   - 输出确认信息                                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 1: ACE 上下文加载 ⚡ 必须执行                            │
│   - 调用 ace-tool                         │
│   - 根据 SCOPE 选择对应的查询策略                             │
│   - 输出 ACE 加载确认                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 获取文件范围                                          │
│   - 执行对应 SCOPE 的 git 命令                                │
│   - 若无变更，提示用户切换范围                                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 深度代码审查                                          │
│   - 结合 ACE 上下文 + 实际代码内容                            │
│   - 按检查清单逐项审查                                        │
│   - 记录问题并标注严重程度                                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 生成 Plan 文件                                        │
│   - 按模板整理审查结果                                        │
│   - 写入 plan/ 目录                                           │
│   - 输出简要总结                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、对话内输出格式

完成后，在对话中输出：

```
✅ Code Review 完成

📋 参数：SCOPE=<scope>, FOCUS=<focus>
🔍 ACE 上下文：N 文件 / M 符号
📁 Plan 文件：plan/YYYY-MM-DD_code-review-<scope>.md
📊 审查范围：<scope>（N 个文件）
🔍 发现问题：🔴 N / 🟡 N / 🟢 N

下一步：
- 执行 `/prompts:plan_to_issues_csv` 将 plan 转为可追踪的 issues
- 或直接开始处理 Phase 0 的紧急问题
```

---

## 九、边界情况处理

1. **SCOPE 参数被忽略**：如果发现解析结果与用户输入不符，立即停止并重新解析。
2. **ACE 不可用**：降级到手动文件读取，但需在输出中注明 `⚠️ ACE 降级模式`。
3. **无变更**：提示用户当前范围无变更，建议切换范围或确认分支。
4. **文件过多（global 超过 100 个）**：
   - 使用 ACE 智能筛选关键文件
   - 或建议使用 `FOCUS` 缩小范围
5. **二进制/大文件**：跳过，在报告中注明。
6. **远程分支不存在（unpushed）**：提示用户设置上游分支或使用其他范围。

---

## 十、ACE 降级策略

当 `ace-tool` 不可用时：

| ACE 能力 | 降级方案 |
|----------|----------|
| 项目结构分析 | `tree -L 3` + 手动阅读入口文件 |
| 依赖分析 | `grep -r "import"` + 手动追踪 |
| 符号搜索 | `rg "symbol"` + LSP |
| 影响范围评估 | 手动分析调用链 |

降级模式输出：
```
⚠️ ACE 降级模式
- 原因：<错误信息>
- 影响：审查速度较慢，上下文可能不完整
- 建议：检查 ace-tool MCP 配置
```
